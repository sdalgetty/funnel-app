<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Funnel Calculator</title>
  <style>
    :root{
      --bg:#0f0f10; --panel:#1b1d22; --muted:#8b94a7; --text:#e9edf3; --accent:#8ad1ff;
      --ok:#d0f5d6; --warn:#ffe1b3;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);padding:24px}
    .wrap{max-width:980px;margin:auto}
    h1{margin:0 0 20px;font-weight:700;letter-spacing:.2px}
    .grid{display:grid;gap:14px}
    @media (min-width:800px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border-radius:14px;padding:18px;border:1px solid #2a2e36}
    .section-title{font-size:14px;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;margin-bottom:10px}
    label{font-size:14px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:center;margin:8px 0}
    input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #343a46;background:#121419;color:var(--text)}
    .suffix{display:flex;align-items:center;gap:8px}
    .suffix span{color:var(--muted)}
    .kpi{display:flex;justify-content:space-between;align-items:baseline;padding:10px 12px;border-radius:12px;background:#121419;border:1px solid #2a2e36;margin:8px 0}
    .kpi .label{color:var(--muted);font-size:14px}
    .kpi .value{font-weight:700;font-size:20px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .good{background:linear-gradient(0deg, transparent, transparent), var(--ok)}
    .warn{background:linear-gradient(0deg, transparent, transparent), var(--warn)}
    .pill{display:inline-block;background:#10141b;border:1px solid #2a2e36;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
    .footer{color:var(--muted);font-size:12px;margin-top:14px}
    a{color:var(--accent);text-decoration:none}

    /* Readability override for highlighted pace boxes */
    .good .value, .warn .value { color: black; }

    /* Auth bar + toast */
    #auth-bar { display:flex; gap:8px; align-items:center; margin-bottom:14px }
    #signin-google, #signout {
      background:#121419; color:#e9edf3; border:1px solid #2a2e36; border-radius:10px;
      padding:8px 12px; cursor:pointer;
    }
    #signin-google:hover, #signout:hover { filter:brightness(1.1); }
    #save-toast{
      position:fixed; left:12px; bottom:12px; padding:6px 10px; border-radius:999px;
      background:#10141b; border:1px solid #2a2e36; color:#8b94a7;
      opacity:0; transition:opacity .2s; pointer-events:none; z-index:9999;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sales Funnel Calculator</h1>

    <!-- Auth UI -->
    <div id="auth-bar">
      <button id="signin-google" style="display:none">Sign in with Google</button>
      <button id="signout" style="display:none">Sign out</button>
      <span id="whoami" style="color:#8b94a7"></span>
    </div>

    <!-- Signed-out message -->
    <div id="signed-out" style="display:none">
      <div class="card">
        <div class="section-title">Save your numbers</div>
        <p>Sign in to save your calculator values and load them on any device.</p>
      </div>
    </div>

    <!-- App content (gated) -->
    <div id="app-wrap" style="display:none">
      <div class="grid">
        <!-- Goals -->
        <div class="card" id="goals">
          <div class="section-title">Inputs â€” Annual Goals</div>
          <div class="row">
            <label for="bookingsGoal">Bookings Goal</label>
            <input type="number" id="bookingsGoal" min="0" step="1" value="45" />
          </div>
          <div class="row">
            <label for="inquiryToCall">Inquiry â†’ Call %</label>
            <div class="suffix">
              <input type="number" id="inquiryToCall" min="0" max="100" step="1" value="50" />
              <span>%</span>
            </div>
          </div>
          <div class="row">
            <label for="callToBooking">Call â†’ Booking %</label>
            <div class="suffix">
              <input type="number" id="callToBooking" min="0" max="100" step="1" value="30" />
              <span>%</span>
            </div>
          </div>

          <div class="section-title" style="margin-top:14px">Outputs â€” Required Activity</div>
          <div class="kpi">
            <div class="label">Required Inquiries</div>
            <div class="value" id="reqInquiries">â€”</div>
          </div>
          <div class="kpi">
            <div class="label">Required Sales Calls</div>
            <div class="value" id="reqCalls">â€”</div>
          </div>
        </div>

        <!-- Progress / Pace -->
        <div class="card" id="progress">
          <div class="section-title">Progress â€” Actual YTD</div>
          <div class="row">
            <label for="inqYtd">Inquiries YTD</label>
            <input type="number" id="inqYtd" min="0" step="1" value="182" />
          </div>
          <div class="row">
            <label for="callsYtd">Calls YTD</label>
            <input type="number" id="callsYtd" min="0" step="1" value="89" />
          </div>
          <div class="row">
            <label for="bookingsYtd">Bookings YTD</label>
            <input type="number" id="bookingsYtd" min="0" step="1" value="32" />
          </div>

          <div class="section-title" style="margin-top:14px">Annualized Pace</div>
          <div class="kpi" id="paceInqBox">
            <div class="label">Inquiries Pace</div>
            <div class="value" id="paceInq">â€”</div>
          </div>
          <div class="kpi" id="paceCallsBox">
            <div class="label">Calls Pace</div>
            <div class="value" id="paceCalls">â€”</div>
          </div>
          <div class="kpi" id="paceBookingsBox">
            <div class="label">Bookings Pace</div>
            <div class="value" id="paceBookings">â€”</div>
          </div>
        </div>
      </div>

      <div class="footer"></div>
    </div>
  </div>

  <!-- Core calculator logic -->
  <script>
    // Helpers
    const el = id => document.getElementById(id);
    const num = v => { const x = parseFloat(v); return Number.isFinite(x) ? x : 0; };
    const fmtInt = v => isNaN(v) ? "â€”" : Math.round(v).toLocaleString();

    // Months elapsed (0.xx in Jan â€¦ ~7.xx mid-Aug â€¦ 12.00 at year end)
    function monthsElapsedAuto(){
      const d = new Date();
      const monthIndex0to11 = d.getMonth(); // 0..11
      const day = d.getDate();
      const daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
      const fractional = day / daysInMonth;
      return monthIndex0to11 + fractional; // correct: no +1
    }

    function recalc(){
      const bookingsGoal = num(el("bookingsGoal").value);
      const pctInquiryToCall = num(el("inquiryToCall").value) / 100;
      const pctCallToBooking = num(el("callToBooking").value) / 100;

      // Requirements from goals
      const requiredCalls = pctCallToBooking > 0 ? bookingsGoal / pctCallToBooking : NaN;
      const requiredInquiries = (pctInquiryToCall > 0 && Number.isFinite(requiredCalls))
        ? requiredCalls / pctInquiryToCall : NaN;

      el("reqCalls").textContent = fmtInt(requiredCalls);
      el("reqInquiries").textContent = fmtInt(requiredInquiries);

      // Progress / Pace (months auto)
      const months = Math.min(12, Math.max(0.01, monthsElapsedAuto()));
      const inqYTD = num(el("inqYtd").value);
      const callsYTD = num(el("callsYtd").value);
      const bookingsYTD = num(el("bookingsYtd").value);

      const paceInq = (inqYTD / months) * 12;
      const paceCalls = (callsYTD / months) * 12;
      const paceBookings = (bookingsYTD / months) * 12;

      el("paceInq").textContent = fmtInt(paceInq);
      el("paceCalls").textContent = fmtInt(paceCalls);
      el("paceBookings").textContent = fmtInt(paceBookings);

      // Highlight pace vs goal (bookings)
      const box = el("paceBookingsBox");
      box.classList.remove("good","warn");
      if (Number.isFinite(paceBookings) && Number.isFinite(bookingsGoal) && bookingsGoal>0){
        if (paceBookings >= bookingsGoal) box.classList.add("good");
        else box.classList.add("warn");
      }
    }

    // Wire inputs
    ["bookingsGoal","inquiryToCall","callToBooking","inqYtd","callsYtd","bookingsYtd"]
      .forEach(id => el(id)?.addEventListener("input", recalc));

    // Init
    recalc();
  </script>

  <!-- Version badge -->
  <div id="version-badge" style="position:fixed;right:12px;bottom:12px;font:12px/1.2 system-ui;padding:8px 10px;border-radius:999px;background:#10141b;border:1px solid #2a2e36;color:#8b94a7"></div>
  <script>
    (function () {
      try {
        const d = new Date(document.lastModified);
        const pretty = d.toLocaleString([], {year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
        document.getElementById('version-badge').textContent = `Last updated: ${pretty}`;
      } catch (e) {
        var el = document.getElementById('version-badge');
        if (el) el.textContent = 'Updated just now';
      }
    })();
  </script>

  <!-- Save toast -->
  <div id="save-toast">Saved</div>

  <!-- Supabase auth + per-user save/load -->
   <!-- Injected at build time by Netlify (placeholders replaced via env vars) -->
<script>
  window.ENV = {
    SUPABASE_URL: "__SUPABASE_URL__",
    SUPABASE_ANON_KEY: "__SUPABASE_ANON_KEY__"
  };
</script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ðŸ”§ TODO: paste your Supabase project values
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV;
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error("Missing Supabase env vars (placeholders not replaced). Check Netlify build command & env vars.");
  }
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const signInBtn = $("signin-google");
    const signOutBtn = $("signout");
    const whoami = $("whoami");
    const appWrap = $("app-wrap");
    const signedOut = $("signed-out");
    const toast = $("save-toast");

    // Fields to persist
    const FIELD_IDS = ["bookingsGoal","inquiryToCall","callToBooking","inqYtd","callsYtd","bookingsYtd"];

    function showSignedIn(email){
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
      whoami.textContent = `Signed in as ${email}`;
      signedOut.style.display = "none";
      appWrap.style.display = "block";
      if (typeof recalc === "function") recalc();
    }
    function showSignedOut(){
      signInBtn.style.display = "inline-block";
      signOutBtn.style.display = "none";
      whoami.textContent = "";
      appWrap.style.display = "none";
      signedOut.style.display = "block";
    }

    signInBtn.addEventListener("click", async () => {
      await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: window.location.origin + window.location.pathname }
      });
    });
    signOutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      showSignedOut();
    });

    const toCol = (id) => ({
      bookingsGoal: "bookings_goal",
      inquiryToCall: "inquiry_to_call",
      callToBooking: "call_to_booking",
      inqYtd: "inquiries_ytd",
      callsYtd: "calls_ytd",
      bookingsYtd: "bookings_ytd"
    })[id] || id;

    function collect(userId){
      const payload = { user_id: userId, name: "Default", updated_at: new Date().toISOString() };
      FIELD_IDS.forEach(id => {
        const el = $(id);
        if (!el) return;
        const v = el.type === "number" ? parseFloat(el.value || "0") : el.value;
        payload[toCol(id)] = Number.isNaN(v) ? null : v;
      });
      return payload;
    }

    // Debounced save with visual toast + console errors
    let saveTimer;
    function wireSaves(userId){
      FIELD_IDS.forEach(id => {
        const el = $(id);
        if (!el) return;
        el.addEventListener("input", () => {
          clearTimeout(saveTimer);
          saveTimer = setTimeout(async () => {
            const payload = collect(userId);
            const { error } = await supabase
              .from("funnels")
              .upsert(payload, { onConflict: "user_id,name" });
            if (error) {
              console.error("Save error:", error);
            } else if (toast) {
              toast.style.opacity = 1; setTimeout(()=> toast.style.opacity = 0, 800);
            }
          }, 500);
        });
      });
    }

    // Load the most recent row (even if multiple exist)
    async function loadFunnel(userId){
      const { data, error } = await supabase
        .from("funnels")
        .select("*")
        .eq("user_id", userId)
        .eq("name","Default")
        .order("updated_at", { ascending: false })
        .limit(1);

      if (error) {
        console.error("Load error:", error);
        return;
      }

      const row = data && data[0];
      if (row){
        FIELD_IDS.forEach(id => {
          const el = $(id);
          const val = row[toCol(id)];
          if (el && val != null) el.value = val;
        });
        if (typeof recalc === "function") recalc();
      } else {
        // First save to create a row
        const first = collect(userId);
        const { error: e2 } = await supabase.from("funnels").insert(first);
        if (e2) console.error("Initial insert error:", e2);
      }
    }

    // Init auth + data flow
    (async () => {
      await supabase.auth.getSession(); // handle OAuth redirect
      const { data: { user } } = await supabase.auth.getUser();

      if (user){
        showSignedIn(user.email || "user");
        await loadFunnel(user.id);
        wireSaves(user.id);
      } else {
        showSignedOut();
      }

      supabase.auth.onAuthStateChange(async (_evt, session) => {
        const u = session?.user;
        if (u){
          showSignedIn(u.email || "user");
          await loadFunnel(u.id);
          wireSaves(u.id);
        } else {
          showSignedOut();
        }
      });
    })();
  </script>
</body>
</html>

